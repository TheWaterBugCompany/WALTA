//>>built
define("dijit/_editor/plugins/EnterKeyHandling","dojo/_base/declare,dojo/dom-construct,dojo/_base/event,dojo/keys,dojo/_base/lang,dojo/sniff,dojo/_base/window,dojo/window,../_Plugin,../RichText,../range,../../_base/focus".split(","),function(q,k,r,s,n,w,t,o,u,p,i,v){return q("dijit._editor.plugins.EnterKeyHandling",u,{blockNodeForEnter:"BR",constructor:function(a){if(a){if("blockNodeForEnter"in a)a.blockNodeForEnter=a.blockNodeForEnter.toUpperCase();n.mixin(this,a)}},setEditor:function(a){if(this.editor!==
a)if(this.editor=a,"BR"==this.blockNodeForEnter)this.editor.customUndo=!0,a.onLoadDeferred.then(n.hitch(this,function(b){this.connect(a.document,"onkeypress",function(a){if(a.charOrCode==s.ENTER){var b=n.mixin({},a);b.shiftKey=!0;this.handleEnterKey(b)||r.stop(a)}});return b}));else if(this.blockNodeForEnter){var b=n.hitch(this,this.handleEnterKey);a.addKeyHandler(13,0,0,b);a.addKeyHandler(13,0,1,b);this.connect(this.editor,"onKeyPressed","onKeyPressed")}},onKeyPressed:function(){if(this._checkListLater){if(t.withGlobal(this.editor.window,
"isCollapsed",v)){var a=this.editor._sCall("getAncestorElement",["LI"]);if(a){var b=a.firstChild;if(b&&1==b.nodeType&&("UL"==b.nodeName||"OL"==b.nodeName))a.insertBefore(b.ownerDocument.createTextNode("\u00a0"),b),b=i.create(this.editor.window),b.setStart(a.firstChild,0),a=i.getSelection(this.editor.window,!0),a.removeAllRanges(),a.addRange(b)}else p.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter),(a=this.editor._sCall("getAncestorElement",[this.blockNodeForEnter]))?a.innerHTML=
this.bogusHtmlContent:console.error("onKeyPressed: Cannot find the new block node")}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(a){var x;var b,c,f,g,j=this.editor.document,e,d,l;if(a.shiftKey){a=this.editor._sCall("getParentElement",[]);if(g=i.getAncestor(a,
this.blockNodes)){if("LI"==g.tagName)return!0;a=i.getSelection(this.editor.window);b=a.getRangeAt(0);b.collapsed||(b.deleteContents(),a=i.getSelection(this.editor.window),b=a.getRangeAt(0));if(i.atBeginningOfContainer(g,b.startContainer,b.startOffset))e=j.createElement("br"),c=i.create(this.editor.window),g.insertBefore(e,g.firstChild),c.setStartAfter(e),a.removeAllRanges(),a.addRange(c);else if(i.atEndOfContainer(g,b.startContainer,b.startOffset))c=i.create(this.editor.window),e=j.createElement("br"),
g.appendChild(e),g.appendChild(j.createTextNode("\u00a0")),c.setStart(g.lastChild,0),a.removeAllRanges(),a.addRange(c);else return(d=b.startContainer)&&3==d.nodeType?(l=d.nodeValue,f=j.createTextNode(l.substring(0,b.startOffset)),b=j.createTextNode(l.substring(b.startOffset)),g=j.createElement("br"),""==b.nodeValue&&(b=j.createTextNode("\u00a0")),k.place(f,d,"after"),k.place(g,f,"after"),k.place(b,g,"after"),k.destroy(d),c=i.create(this.editor.window),c.setStart(b,0),a.removeAllRanges(),a.addRange(c),
!1):!0}else if(a=i.getSelection(this.editor.window),a.rangeCount){if((b=a.getRangeAt(0))&&b.startContainer){b.collapsed||(b.deleteContents(),a=i.getSelection(this.editor.window),b=a.getRangeAt(0));if((d=b.startContainer)&&3==d.nodeType){g=b.startOffset;if(d.length<g)h=this._adjustNodeAndOffset(d,g),d=h.node,g=h.offset;l=d.nodeValue;f=j.createTextNode(l.substring(0,g));b=j.createTextNode(l.substring(g));g=j.createElement("br");b.length||(b=j.createTextNode("\u00a0"));f.length?k.place(f,d,"after"):
f=d;k.place(g,f,"after");k.place(b,g,"after");k.destroy(d)}else 0<=b.startOffset&&(e=d.childNodes[b.startOffset]),g=j.createElement("br"),b=j.createTextNode("\u00a0"),e?(k.place(g,e,"before"),k.place(b,g,"after")):(d.appendChild(g),d.appendChild(b));c=i.create(this.editor.window);c.setStart(b,0);c.setEnd(b,b.length);a.removeAllRanges();a.addRange(c);this.editor._sCall("collapse",[!0])}}else p.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var m=!0,a=i.getSelection(this.editor.window);
b=a.getRangeAt(0);b.collapsed||(b.deleteContents(),a=i.getSelection(this.editor.window),b=a.getRangeAt(0));c=i.getBlockAncestor(b.endContainer,null,this.editor.editNode);if(this._checkListLater=(e=c.blockNode)&&("LI"==e.nodeName||"LI"==e.parentNode.nodeName)){if(/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(e.innerHTML))e.innerHTML="",c=i.create(this.editor.window),c.setStart(e,0),a.removeAllRanges(),a.addRange(c),this._checkListLater=
!1;return!0}if(!c.blockNode||c.blockNode===this.editor.editNode){try{p.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(n){}c={blockNode:this.editor._sCall("getAncestorElement",[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(c.blockNode){if(c.blockNode!=this.editor.editNode&&!(c.blockNode.textContent||c.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(c.blockNode),!1}else c.blockNode=this.editor.editNode;a=i.getSelection(this.editor.window);
b=a.getRangeAt(0)}e=j.createElement(this.blockNodeForEnter);e.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(c.blockNode);h=b.endOffset;m=b.endContainer;if(m.length<h)var h=this._adjustNodeAndOffset(m,h),m=h.node,h=h.offset;if(i.atEndOfContainer(c.blockNode,m,h))c.blockNode===c.blockContainer?c.blockNode.appendChild(e):k.place(e,c.blockNode,"after"),m=!1,c=i.create(this.editor.window),c.setStart(e,0),a.removeAllRanges(),a.addRange(c),this.editor.height&&o.scrollIntoView(e);else if(i.atBeginningOfContainer(c.blockNode,
b.startContainer,b.startOffset))k.place(e,c.blockNode,c.blockNode===c.blockContainer?"first":"before"),e.nextSibling&&this.editor.height&&(c=i.create(this.editor.window),c.setStart(e.nextSibling,0),a.removeAllRanges(),a.addRange(c),o.scrollIntoView(e.nextSibling)),m=!1;else{c.blockNode===c.blockContainer?c.blockNode.appendChild(e):k.place(e,c.blockNode,"after");m=!1;if(c.blockNode.style&&e.style&&c.blockNode.style.cssText)e.style.cssText=c.blockNode.style.cssText;if((d=b.startContainer)&&3==d.nodeType){h=
b.endOffset;if(d.length<h)h=this._adjustNodeAndOffset(d,h),d=h.node,h=h.offset;l=d.nodeValue;f=j.createTextNode(l.substring(0,h));b=j.createTextNode(l.substring(h,l.length));k.place(f,d,"before");k.place(b,d,"after");k.destroy(d);for(f=f.parentNode;f!==c.blockNode;){h=j.createElement(f.tagName);if(f.style&&h.style&&f.style.cssText)h.style.cssText=f.style.cssText;if("FONT"===f.tagName){if(f.color)h.color=f.color;if(f.face)h.face=f.face;if(f.size)h.size=f.size}for(d=b;d;)b=d.nextSibling,h.appendChild(d),
d=b;k.place(h,f,"after");b=h;f=f.parentNode}d=b;if(1==d.nodeType||3==d.nodeType&&d.nodeValue)e.innerHTML="";for(f=d;d;)b=d.nextSibling,e.appendChild(d),d=b}c=i.create(this.editor.window);j=f;if("BR"!==this.blockNodeForEnter){for(;j;)g=j,x=b=j.firstChild,j=x;g&&g.parentNode?(e=g.parentNode,c.setStart(e,0),a.removeAllRanges(),a.addRange(c),this.editor.height&&o.scrollIntoView(e)):m=!0}else c.setStart(e,0),a.removeAllRanges(),a.addRange(c),this.editor.height&&o.scrollIntoView(e)}return m},_adjustNodeAndOffset:function(a,
b){for(;a.length<b&&a.nextSibling&&3==a.nextSibling.nodeType;)b-=a.length,a=a.nextSibling;return{node:a,offset:b}},removeTrailingBr:function(a){if(a=/P|DIV|LI/i.test(a.tagName)?a:this.editor._sCall("getParentOfType",[a,["P","DIV","LI"]]))if(a.lastChild&&(1<a.childNodes.length&&3==a.lastChild.nodeType&&/^[\s\xAD]*$/.test(a.lastChild.nodeValue)||"BR"==a.lastChild.tagName)&&k.destroy(a.lastChild),!a.childNodes.length)a.innerHTML=this.bogusHtmlContent}})});