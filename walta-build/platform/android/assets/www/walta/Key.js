//>>built
define("walta/Key","dojo/_base/declare,dojo/request/xhr,dojo/_base/lang,dojo/_base/array,walta/XmlDocument,walta/KeyNode,walta/Taxon,walta/Question".split(","),function(h,o,j,i,k,l,m,n){return h(null,{url:null,name:null,currentDecision:null,choose:function(b){return this.currentDecision=this.currentDecision.questions[b].outcome},back:function(){return this.currentDecision.parentLink?(this.currentDecision=this.currentDecision.parentLink,!0):!1},reset:function(){this.currentDecision=this._rootNode},
lookupNode:function(b){return this.currentDecision=b=this._lookUpNodeByRef(b)},constructor:function(b){h.safeMixin(this,b)},load:function(){this._xml=new k({url:this.url+"/key.xml",namespaceMap:{tax:"http://thewaterbug.net/taxonomy"}});return this._xml.load().then(j.hitch(this,function(){try{this.name=this._xml.getString(null,"/tax:key/@name"),this._parseKeyXML(this.url,this._xml),this.currentDecision=this._rootNode}catch(b){console.error("Failed to load key: "+b)}}))},_mapFromIdToNode:{},_rootNode:null,
_forwardLinks:[],_lookUpNodeByRef:function(b){return this._mapFromIdToNode[b]},_parseKeyXML:function(b,c){this._parseTaxonFromXML(b,c,this._xml.getNode(null,"/tax:key"));for(var a=this._xml.getNodeArray(null,"/tax:key/tax:keyNode");0<a.length;){var d=this._parseKeyNodeFromXML(b,c,a.shift());if(null==this._rootNode)this._rootNode=d}},_parseKeyNodeFromXML:function(b,c,a){for(var d=new l,e=1;2>=e;e++)try{d.questions.push(this._parseQuestionFromXML(b,c,c.getNode(a,"tax:question[@num="+e+"]"),d))}catch(g){console.error("Parsing failed for question "+
e+": "+g)}i.forEach(d.questions,function(a){if(a.outcome)a.outcome.parentLink=d});b=c.getString(a,"@id");if(""!==b){if(b in this._forwardLinks)c=this._forwardLinks[b],c.qNode.outcome=d,d.parentLink=c.pLink,delete this._forwardLinks[b];this._mapFromIdToNode[b]=d}return d},_parseQuestionFromXML:function(b,c,a,d){var e=new n;e.text=c.getString(a,"tax:text");e.mediaUrls=this._parseMediaUrls(b,c,a);var g=c.getNumber(a,"@num");if(isNaN(g)){if(""===c.getString(a,"@num"))throw"Missing num attribute on question node.";
throw"Unable to interpret @num as an integer: @num = 'NaN";}var f=c.getNode(a,"../tax:outcome[@for="+g+"]/*"),a=null;if(null===f)throw"Can't find outcome: "+g;if("taxonLink"===f.tagName||"keyNodeLink"===f.tagName)a=c.getString(f,"@ref"),b=this._lookUpNodeByRef(a),e.outcome=b;else if("keyNode"===f.tagName)e.outcome=this._parseKeyNodeFromXML(b,c,f);""!==a&&null==e.outcome&&(this._forwardLinks[a]={qNode:e,pLink:d});return e},_parseMediaUrls:function(b,c,a){var d=[];i.forEach(c.getStringArray(a,"child::tax:mediaRef/@url"),
function(a){d.push(b+"/media/"+a)});return d},_parseTaxonFromXML:function(b,c,a){if("taxon"===a.tagName){var d=new m({id:c.getString(a,"@id"),name:c.getString(a,"@name"),commonName:c.getString(a,"@commonName"),size:c.getNumber(a,"@size"),signalScore:c.getNumber(a,"@signalScore"),habitat:c.getString(a,"tax:habitat"),movement:c.getString(a,"tax:movement"),confusedWith:c.getString(a,"tax:confusedWith"),mediaUrls:this._parseMediaUrls(b,c,a)});""!==d.id&&(this._mapFromIdToNode[d.id]=d)}for(a=this._xml.getNodeArray(a,
"tax:taxon");0<a.length;)nd=a.shift(),this._parseTaxonFromXML(b,c,nd)}})});