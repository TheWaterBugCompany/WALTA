//>>built
define("walta/Key","dojo/_base/declare,dojo/request/xhr,dojo/_base/lang,dojo/_base/array,walta/XmlDocument,walta/KeyNode,walta/Taxon,walta/Question".split(","),function(h,o,j,i,k,l,m,n){return h(null,{url:null,name:null,currentDecision:null,choose:function(c){return this.currentDecision=this.currentDecision.questions[c].outcome},back:function(){return this.currentDecision.parentLink?(this.currentDecision=this.currentDecision.parentLink,!0):!1},reset:function(){this.currentDecision=this._rootNode},
lookupNode:function(c){return this.currentDecision=c=this._lookUpNodeByRef(c)},constructor:function(c){h.safeMixin(this,c)},load:function(){this._xml=new k({url:this.url+"/key.xml",namespaceMap:{tax:"http://thewaterbug.net/taxonomy"}});return this._xml.load().then(j.hitch(this,function(){try{this.name=this._xml.getString(null,"/tax:key/@name"),this._parseKeyXML(this.url,this._xml),this.currentDecision=this._rootNode}catch(c){console.error("Failed to load key: "+c)}}))},_taxIdToNode:{},_keyIdToNode:{},
_rootNode:null,_forwardLinks:[],_lookUpNodeByRef:function(c){var b=this._taxIdToNode[c];b||(b=this._keyIdToNode[c]);return b},_parseKeyXML:function(c,b){this._parseTaxonFromXML(c,b,this._xml.getNode(null,"/tax:key"));for(var a=this._xml.getNodeArray(null,"/tax:key/tax:keyNode");0<a.length;){var d=this._parseKeyNodeFromXML(c,b,a.shift());if(null==this._rootNode)this._rootNode=d}},_parseKeyNodeFromXML:function(c,b,a){for(var d=new l,e=1;2>=e;e++)try{d.questions.push(this._parseQuestionFromXML(c,b,b.getNode(a,
"tax:question[@num="+e+"]"),d))}catch(f){console.error("Parsing failed for question "+e+": "+f),console.debug(a)}i.forEach(d.questions,function(a){if(a.outcome)a.outcome.parentLink=d});c=b.getString(a,"@id");if(""!==c){if(c in this._forwardLinks)b=this._forwardLinks[c],b.qNode.outcome=d,d.parentLink=b.pLink,delete this._forwardLinks[c];this._keyIdToNode[c]=d}return d},_parseQuestionFromXML:function(c,b,a,d){var e=new n;e.text=b.getString(a,"tax:text");e.mediaUrls=this._parseMediaUrls(c,b,a);var f=
b.getNumber(a,"@num");if(isNaN(f)){if(""===b.getString(a,"@num"))throw"Missing num attribute on question node: "+e.text;throw"Unable to interpret @num as an integer: @num = '"+f+"' on question node: "+e.text;}var a=b.getNode(a,"../tax:outcome[@for="+f+"]/*"),g=null;if(null===a)throw"Can't find outcome: "+f;if("taxonLink"===a.tagName||"keyNodeLink"===a.tagName)g=b.getString(a,"@ref"),e.outcome="taxonLink"===a.tagName?this._taxIdToNode[g]:this._keyIdToNode[g];else if("keyNode"===a.tagName)e.outcome=
this._parseKeyNodeFromXML(c,b,a);""!==g&&null==e.outcome&&(this._forwardLinks[g]={qNode:e,pLink:d});return e},_parseMediaUrls:function(c,b,a){var d=[];i.forEach(b.getStringArray(a,"child::tax:mediaRef/@url"),function(a){d.push(c+"/media/"+a)});return d},_parseTaxonFromXML:function(c,b,a){if("taxon"===a.tagName){var d=new m({id:b.getString(a,"@id"),name:b.getString(a,"@name"),commonName:b.getString(a,"@commonName"),size:b.getNumber(a,"@size"),signalScore:b.getNumber(a,"@signalScore"),habitat:b.getString(a,
"tax:habitat"),movement:b.getString(a,"tax:movement"),confusedWith:b.getString(a,"tax:confusedWith"),mediaUrls:this._parseMediaUrls(c,b,a)});""!==d.id&&(this._taxIdToNode[d.id]=d)}for(a=this._xml.getNodeArray(a,"tax:taxon");0<a.length;)nd=a.shift(),this._parseTaxonFromXML(c,b,nd)}})});